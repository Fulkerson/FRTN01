latexfile = report
#cpdir = ../../docs

all: $(latexfile).pdf

#failtable.tex:
#	../src/failbench.py > failtable.tex

$(latexfile).pdf : $(latexfile).tex vc.tex build_dir
	while (xelatex -output-directory=build -shell-escape $(latexfile).tex 2> /dev/null ; \
	grep -q "Rerun to get cross" build/$(latexfile).log ) do true ; \
	done
#	mkdir -p $(cpdir)
#	cp $(latexfile).pdf $(cpdir)

vc.tex: ../.git/logs/HEAD
	echo "%%% This file is generated by Makefile." > vc.tex
	echo "%%% Do not edit this file!\n%%%" >> vc.tex
	echo "\\gdef\\GITTag{"`git describe`"}" >> vc.tex
	git log -1 --date="short" --format="format:\
		\\gdef\\GITAbrHash{%h}\
		\\gdef\\GITDate{%ad}\
		\\gdef\\GITAuthorName{%an}" >> vc.tex

build_dir:
	mkdir -p build

clean:
	rm -rf build
	rm -rf vc.tex
